# VRCSSDateTimeFixer 開発者ガイド

## このドキュメントの目的（概要）
- 本プロジェクトのビルド/テスト/リリースに関わる手順とスクリプトの役割を簡潔にまとめます。
- 対象読者: 開発者・リリース担当者。

## 前提・環境
- OS: Windows（PowerShell 実行を想定）
- リポジトリ直下の PowerShell スクリプト（`*.ps1`）を使用
- Git 操作は基本的にコマンドライン例を記載

## クイックスタート（最短でやりたいこと）
- 開発中にローカルでビルドとテストを実行したい:
  - ビルドとパッケージ（確認用）: `./Release.ps1`
  - 単体テストを含むクリーンビルドが走ります（リリース前確認にも使用）
- リリースしたい（概要フロー）:
  1) リリースブランチ作成（例: `release/vX.Y.Z`）
  2) バージョンと CHANGELOG 更新（後述「2. リリース前の準備」）
  3) `./Release.ps1` でパッケージ作成とテスト確認
  4) `./create_release.ps1` で GitHub ドラフト作成
  5) `./publish_release.ps1` で公開
  6) `./finalize_release.ps1` で最終処理（タグ作成・配布物作成 など）
 
→ 各スクリプトの役割・使いどころの詳細は「[スクリプトリファレンス](#スクリプトリファレンス)」を参照してください。

---

## リリースプロセス

### 1. 開発完了の確認
リリースを開始する前に、以下の項目を確認してください：
- すべての機能が実装され、テストが完了していること
- ドキュメントが最新であること
- チーム内でリリースの承認を得ていること

### 2. リリース前の準備

> **重要**: 以下の2つの手順は、`finalize_release.ps1` を実行する前に必ず完了させてください。
> 
> `finalize_release.ps1` スクリプトは以下の処理を行います：
> - リリース用のコミット作成
> - バージョンタグの作成
> - リリースパッケージのビルド
> - 配布用ファイルのコピー

#### 2.1 バージョン番号の更新（.csproj → version.ps1 に同期）
本プロジェクトでは、バージョンのソース・オブ・トゥルースは **`.csproj` の `<Version>`** です。PowerShell スクリプト群は `version.ps1` を読み込んで動作します。手順は次のとおり：
1. プロジェクトファイル（`.csproj`）の `<Version>` を更新する
2. ルートで次を実行し、`version.ps1` を生成する：
   ```powershell
   .\read_version_from_csproj.ps1
   ```
> メモ: 各スクリプト（`Release.ps1`/`finalize_release.ps1`/`create_release.ps1`/`publish_release.ps1`/`build.ps1`）は `version.ps1` を参照するため、個別に `$version` を修正する必要はありません。

#### 2.2 変更履歴の更新
`CHANGELOG.md` を編集して、新しいバージョンのセクションを追加してください：
- 新しいバージョン番号の見出しを追加
- 変更点をカテゴリ別（新機能、バグ修正など）に分類
- リリース日を追記

> **確認**: 2.1 で説明されているバージョン番号と 2.2 で説明されている変更履歴が正しく更新されていることを確認してください。

### 3. リリースの実行

#### 3.1 リリースブランチの作成
```bash
git checkout -b release/vX.Y.Z
```

#### 3.2 リリースパッケージの作成と確認
1. 以下のコマンドを実行してリリースパッケージを作成：
   ```powershell
   .\Release.ps1
   ```
2. 生成されたパッケージをテスト環境で検証

#### 3.3 GitHubリリースの作成
1. 以下のコマンドでドラフトリリースを作成：
   ```powershell
   .\create_release.ps1
   ```
2. チームでドラフトリリースを確認・承認

#### 3.4 リリースの公開
1. 以下のコマンドでリリースを公開：
   ```powershell
   .\publish_release.ps1
   ```

#### 3.5 リリースの最終処理
1. 以下のコマンドでリリースを完了：
   ```powershell
   .\finalize_release.ps1
   ```
2. リリースブランチをmainにマージ：
   ```bash
   git checkout main
   git merge --no-ff release/vX.Y.Z
   git push origin main
   ```
3. リリースブランチを削除：
   ```bash
   git branch -d release/vX.Y.Z
   git push origin --delete release/vX.Y.Z
   ```

### 4. リリース後の確認
1. GitHubのリリースページで正しく公開されていることを確認
2. ダウンロード可能なアセットが正しく添付されていることを確認
3. 必要に応じて、チームやユーザーにリリースを通知

## スクリプトリファレンス

### ビルドスクリプト
#### `build.ps1`
- **目的**: アプリケーションのビルドとパッケージング
- **実行タイミング**: リリース前のビルド作成時
- **実行者**: 開発者
- **主な機能**:
  - アプリケーションのビルド
  - 単一実行ファイルの生成
  - 配布用ZIPファイルの作成
 - **入出力例**:
   - 入力（前提）:
     - `.NET SDK` がインストール済み
     - スクリプト内の `$version` `"1.0.0"` と `$runtime` `"win-x64"` を使用
   - 出力:
     - 公開フォルダ: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64/`
     - ZIP: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64.zip`
     - `README.txt` を公開フォルダ直下に生成

#### `Release.ps1`
- **目的**: リリース用の最終ビルドとテストの実行
- **実行タイミング**: リリース作業時
- **実行者**: リリースマネージャー
- **主な機能**:
  - クリーンビルドの実行
  - ユニットテストの実行
  - パッケージング
  - リリースノートの生成
 - **入出力例**:
   - 入力（前提）:
     - `.NET SDK` がインストール済み、テスト実行可能
     - `$version` `"1.0.0"`、`$runtime` `"win-x64"`
   - 出力:
     - 公開フォルダ: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64/`
       - 同フォルダに `README.md` `LICENSE` `CHANGELOG.md` をコピー
       - `README.txt` を生成
     - ZIP: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64.zip`

### テストスクリプト

#### `TestData/test_script.ps1`
- **目的**: 機能テスト用のスクリプト
- **実行タイミング**: 機能開発時、リグレッションテスト時
- **実行者**: 開発者、テスター
- **主な機能**:
  - テスト用ファイルの生成
  - 基本的な機能テストの実行
  - テスト結果の検証
 - **入出力例**:
   - 入力（前提）:
     - ビルド済み実行ファイル: `VRCSSDateTimeFixer/bin/Release/net8.0/win-x64/publish/VRCSSDateTimeFixer.exe`
   - 出力:
     - テスト用ディレクトリ: `TestData/TestFiles/`（配下に PNG などを生成）
     - コンソール出力（タイムスタンプの変化を表示）

#### `TestData/performance_test.ps1`
- **目的**: パフォーマンステストの実行
- **実行タイミング**: リリース前、パフォーマンスチューニング時
- **実行者**: 開発者
- **主な機能**:
  - 大量のテストファイル生成
  - パフォーマンス計測
  - レポート生成
 - **入出力例**:
   - 入力（前提）:
     - ビルド済み実行ファイル
     - 既定の作成数 `$fileCount = 1000`
   - 出力:
     - `TestData/PerformanceTest/` 配下に多数のテストファイル
     - 実行時間・スループットをコンソール出力

### リリーススクリプト

#### `create_release.ps1`
- **目的**: GitHubリリースのドラフト作成
- **実行タイミング**: リリース作業の最初のステップ
- **実行者**: リリースマネージャー
- **主な機能**:
  - バージョン番号の確認
  - リリースノートの生成
  - ドラフトリリースの作成
 - **入出力例**:
   - 入力（前提）:
     - GitHub CLI `gh` がインストール・認証済み
     - ローカルで `Release.ps1` により ZIP が生成済み
     - `$version` `"1.0.0"`
   - 出力:
     - ZIP パス: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64.zip`
     - 一時ファイル: `bin/Release/Publish/release_notes.md`（実行後に削除）
     - GitHub 上の「ドラフト」リリース（タグ `v1.0.0`、アセット添付）

#### `publish_release.ps1`
- **目的**: リリースの公開
- **実行タイミング**: リリースの最終確認後
- **実行者**: リリースマネージャー
- **主な機能**:
  - リリースアセットのアップロード
  - リリースノートの更新
  - リリースの公開
 - **入出力例**:
   - 入力（前提）:
     - GitHub CLI `gh` がインストール・認証済み
     - `main` ブランチおよび `v1.0.0` タグの push が可能
   - 出力:
     - `git push origin main` と `git push origin v1.0.0` の実行
     - `create_release.ps1` の実行により GitHub 上にドラフトリリース作成・アセット添付

#### `finalize_release.ps1`
- **目的**: リリースの最終処理とパッケージング
- **実行タイミング**: リリース前の最終確認後
- **実行者**: リリースマネージャー
- **主な機能**:
  - リリース用のコミット作成
  - バージョンタグの作成
  - リリースパッケージのビルド
  - 配布用ファイルのコピー
 - **入出力例**:
   - 入力（前提）:
     - `main` ブランチ上・未コミット変更なし
     - テストがローカルで成功する状態
     - `$version` `"1.0.0"`
   - 出力:
     - リリースコミット: `"Prepare for release v1.0.0"`
     - 署名付きタグ: `v1.0.0`
     - ZIP: `bin/Release/Publish/VRCSSDateTimeFixer-1.0.0-win-x64.zip`
     - 配布用ディレクトリ: `dist/` に ZIP と `README.md` `LICENSE` `CHANGELOG.md` をコピー

## トラブルシューティング

### ビルドが失敗する場合
1. 依存関係が正しくインストールされているか確認
2. クリーンビルドを試す
3. エラーメッセージを確認して対応

### テストが失敗する場合
1. テスト環境が正しくセットアップされているか確認
2. テストデータが正しいか確認
3. コードの変更がテストに影響していないか確認
